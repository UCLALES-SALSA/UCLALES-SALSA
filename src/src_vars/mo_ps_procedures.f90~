MODULE mo_ps_procedures
  USE grid, ONLY : nzp,nxp,nyp
  USE mo_stats_finder
  IMPLICIT NONE

  ! Calculate profile statistics. The simple domain mean profile is automatically
  ! available for all 3d (including binned) fields defined during model runtime
  ! (found in the FieldArray instances Prog, Vector, Diag or Derived).
  
  ! Higher-order statistics are yet to be implemented, but will follow the exact same logic.
  ! Conditional statistics also require specific implementations.
  
  PRIVATE

  PUBLIC ::  incloudAvgProfile, precipAvgProfile,  &
             globalAvgProfile, globalAvgProfileBinned
  
  CONTAINS

    SUBROUTINE globalAvgProfile(name,output)
      USE util, ONLY : get_avg3_root
      CHARACTER(len=*), INTENT(in) :: name
      REAL, INTENT(out) :: output(nzp)
      
      REAL :: fvar(nzp,nxp,nyp)
      
      fvar = 0.
      output = 0.
      CALL stats_get3d(name,fvar)
      
      CALL get_avg3_root(nzp,nxp,nyp,fvar,output)      
      
    END SUBROUTINE globalAvgProfile

    ! ----------------------------------------------------
    
    SUBROUTINE globalAvgProfileBinned(name,output,nstr,nend)
      USE util, ONLY : get_avg3_binned_root
      CHARACTER(len=*), INTENT(in) :: name
      INTEGER, INTENT(in) :: nstr,nend
      REAL, INTENT(out) :: output(nzp,nend-nstr+1) 

      REAL :: fvar(nzp,nxp,nyp,nend-nstr+1)
     
      fvar = 0.
      output = 0.
      CALL stats_get3d_binned(name,fvar,nstr,nend)
      
      CALL get_avg3_binned_root(nzp,nxp,nyp,nend-nstr+1,fvar,output)

    END SUBROUTINE globalAvgProfileBinned

    ! -----------------------------------------------------
    
    SUBROUTINE incloudAvgProfile(name,output)
      CHARACTER(len=*), INTENT(in) :: name
      REAL, INTENT(out) :: output(nzp)

      REAL :: fvar(nzp,nxp,nyp)
      REAL :: ncTH = 1.e6
      REAL :: rcTH = 1.e-5

      fvar = 0.
      output = 0.
    END SUBROUTINE incloudAvgProfile

    ! -----------------------------------------------------

    SUBROUTINE precipAvgProfile(name,output)
      CHARACTER(len=*), INTENT(in) :: name
      REAL, INTENT(out) :: output(nzp)
      output = 0.
    END SUBROUTINE precipAvgProfile

    ! -----------------------------------------------------    
    
END MODULE mo_ps_procedures
